<!DOCTYPE html>
<html>

<head>
  <title>First Responder Risk Assessment</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>

  <div class="container">
    <h1>Risk Zone Image and Streaming Assessment</h1>

    <div style="margin-bottom: 30px;">
      <button id="modeToggle" class="mode-btn" onclick="toggleMode()">Switch to Video Mode</button>
    </div>

    <!-- Image Analysis Mode -->
    <div id="imageMode">
      <div id="imagePreview" style="display: none; margin-top: 20px;">
        <img id="preview" style="max-width: 500px; border-radius: 8px;">
      </div>
      
      <input type="file" id="imageInput" name="image" required>
      <div style="margin-top: 20px;">
        <button onclick="analyzeImage('hazards')" class="analysis-btn">Immediate Hazards</button>
        <button onclick="analyzeImage('survivors')" class="analysis-btn">Victims/Survivors</button>
        <button onclick="analyzeImage('precautions')" class="analysis-btn">Recommended Precautions</button>
      </div>
    </div>

    <!-- Video Analysis Mode -->
    <div id="videoMode" style="display: none;">
      <div style="margin-top: 20px;">
        <video id="videoStream" width="500" height="375" autoplay muted playsinline style="border-radius: 8px; border: 2px solid red; background-color: #000;"></video>
        <div style="margin-top: 10px;">
          <button onclick="startWebcam()" class="control-btn">Start Webcam</button>
          <button onclick="stopWebcam()" class="control-btn">Stop Webcam</button>
        </div>
      </div>
      <div style="margin-top: 15px;">
        <button onclick="captureFrame('hazards')" class="analysis-btn" id="captureHazards" disabled>Immediate Hazards</button>
        <button onclick="captureFrame('survivors')" class="analysis-btn" id="captureSurvivors" disabled>Victims/Survivors</button>
        <button onclick="captureFrame('precautions')" class="analysis-btn" id="capturePrecautions" disabled>Recommended Precautions</button>
      </div>
    </div>

    <div id="result" style="display: none;"></div>
  </div>

  <script>
    let videoStream = null;
    let isVideoActive = false;

    // Toggle between image and video mode
    function toggleMode() {
      const imageMode = document.getElementById("imageMode");
      const videoMode = document.getElementById("videoMode");
      const modeToggle = document.getElementById("modeToggle");

      if (imageMode.style.display === "none") {
        imageMode.style.display = "block";
        videoMode.style.display = "none";
        modeToggle.textContent = "Switch to Video Mode";
        if (isVideoActive) stopWebcam();
      } else {
        imageMode.style.display = "none";
        videoMode.style.display = "block";
        modeToggle.textContent = "Switch to Image Mode";
      }
    }

    // Start webcam
    async function startWebcam() {
      try {
        console.log("Requesting webcam access...");
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        console.log("Webcam access granted");
        const video = document.getElementById("videoStream");
        video.srcObject = stream;
        videoStream = stream;
        isVideoActive = true;
        document.getElementById("captureHazards").disabled = false;
        document.getElementById("captureSurvivors").disabled = false;
        document.getElementById("capturePrecautions").disabled = false;
      } catch (err) {
        alert("Unable to access webcam: " + err.message);
      }
    }

    // Stop webcam
    function stopWebcam() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        document.getElementById("videoStream").srcObject = null;
        isVideoActive = false;
        document.getElementById("captureHazards").disabled = true;
        document.getElementById("captureSurvivors").disabled = true;
        document.getElementById("capturePrecautions").disabled = true;
      }
    }

    // Analyze image based on type
    function analyzeImage(analysisType) {
      const fileInput = document.getElementById("imageInput");
      if (!fileInput.files || fileInput.files.length === 0) {
        alert("Please select an image first");
        return;
      }

      const formData = new FormData();
      formData.append("image", fileInput.files[0]);
      formData.append("analysis_type", analysisType);

      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "<p>Analyzing image...</p>";
      resultDiv.style.display = "block";

      fetch("/analyze", {
        method: "POST",
        body: formData
      }).then(response => response.json())
        .then(data => {
          const content = data.analysis || data.error;
          resultDiv.innerHTML = marked.parse(content);
        })
        .catch(err => {
          resultDiv.innerHTML = `<p>Error: ${err.message}</p>`;
        });
    }

    // Capture frame from video and analyze
    function captureFrame(analysisType) {
      const video = document.getElementById("videoStream");
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);
      
      canvas.toBlob(blob => {
        const formData = new FormData();
        formData.append("frame", blob, "frame.jpg");
        formData.append("analysis_type", analysisType);
        
        const resultDiv = document.getElementById("result");
        resultDiv.innerHTML = "<p>Analyzing frame...</p>";
        resultDiv.style.display = "block";
        
        let accumulatedResponse = "";

        fetch("/analyze_stream", {
          method: "POST",
          body: formData
        }).then(response => {
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          
          const readStream = () => {
            return reader.read().then(({ done, value }) => {
              if (done) {
                // Render the complete response as HTML when done
                // Clean up any extra whitespace and render
                const cleanedResponse = accumulatedResponse.trim();
                resultDiv.innerHTML = marked.parse(cleanedResponse);
                return;
              }
              const chunk = decoder.decode(value, { stream: true });
              const lines = chunk.split("\n");
              lines.forEach(line => {
                if (line.startsWith("data: ")) {
                  accumulatedResponse += line.slice(6);
                }
              });
              return readStream();
            });
          };
          return readStream();
        }).catch(err => {
          resultDiv.innerHTML = `<p>Error: ${err.message}</p>`;
        });
      }, "image/jpeg");
    }

    // Image mode - file selection preview
    document.getElementById("imageInput").addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (event) {
          const previewDiv = document.getElementById("imagePreview");
          const previewImg = document.getElementById("preview");
          previewImg.src = event.target.result;
          previewDiv.style.display = "block";
        };
        reader.readAsDataURL(file);
      }
    });
  </script>

</body>

</html>